# 급여 정산 정책 (Salary Calculation Policy)

## 📋 개요

본 문서는 WageManager의 급여 정산 시스템에 대한 상세한 정책과 계산 로직을 설명합니다.

## 🗓️ 급여 계산 기간

### 기본 원칙
- **월급날(Payment Day)** 기준으로 급여 계산 기간이 결정됩니다.
- 예: 월급날이 매월 15일인 경우
  - **1월 급여**: 전년 12월 15일 ~ 1월 14일까지의 근무
  - **2월 급여**: 1월 15일 ~ 2월 14일까지의 근무
- 예: 월급날이 21일인 경우
  - **2월 급여**: 1월 21일 ~ 2월 20일까지의 근무

## 🏢 근무 기록 (WorkRecord) 관리

### 근무 기록 상태 (WorkRecordStatus)

#### 1. SCHEDULED (예정)
- 미래 날짜의 근무 일정
- **급여 계산에 포함되지 않음**

#### 2. COMPLETED (완료)
- 과거 날짜에 생성되거나 명시적으로 완료 처리된 근무
- **급여 계산에 포함됨**

#### 3. DELETED (삭제)
- 소프트 삭제된 근무 기록
- **급여 계산에 포함되지 않음**
- WeeklyAllowance 집계에서도 제외

### 자동 상태 결정
근무 기록 생성 시 날짜를 비교하여 자동으로 상태가 결정됩니다:

- **과거 날짜**: 자동으로 COMPLETED → 즉시 급여에 반영
- **미래 날짜**: SCHEDULED → 급여에 반영 안 됨
- **당일**: SCHEDULED → 수동으로 완료 처리 필요

## 🏢 사업장 규모에 따른 급여 계산

### 5인 미만 사업장
- **모든 가산 수당 미적용**: 야간 수당, 휴일 수당, 일 연장 수당이 적용되지 않음
- **기본 시급만 적용**: 모든 근무 시간에 대해 기본 시급만 지급
- **주휴수당과 주 단위 연장수당은 적용**: WeeklyAllowance에서 계산됨

### 5인 이상 사업장
- **모든 가산 수당 적용**: 야간 수당, 휴일 수당, 연장 수당이 모두 적용됨
- **법정 가산율 적용**: 야간/휴일/연장 각 50% 가산

## 💰 급여 구성 요소

### WorkRecord 레벨의 급여 계산

각 근무 기록(WorkRecord)은 당일 급여를 자동 계산하여 저장합니다:
- **break_minutes**: 휴식 시간 (분 단위)
- **total_work_minutes**: 실제 근무 시간 (분 단위) = (end_time - start_time) - break_minutes
- **base_salary**: 당일 기본급 (5인 이상 사업장의 평일 근무)
- **night_salary**: 당일 야간수당 (5인 이상 사업장만 적용)
- **holiday_salary**: 당일 휴일수당 (5인 이상 사업장만 적용)
- **total_salary**: 당일 총급여 = base_salary + night_salary + holiday_salary

**중요**: 급여 계산은 `WorkRecordCalculationService`를 통해 사업장 규모와 휴일 여부를 고려하여 수행됩니다.

### 월급 레벨의 급여 계산

#### 1. 기본급 (Base Pay)
```
기본급 = 모든 COMPLETED 근무 기록의 base_salary 합계
```
- COMPLETED 상태의 근무 기록만 집계
- DELETED 상태는 제외
- 야간/공휴일 할증 제외

#### 2. 야간 수당 (Night Pay)

**5인 이상 사업장만 적용**

##### 평일 야간 근무
- **22:00 ~ 06:00** 시간대 근무에 적용
- **8시간 이하**: 야간 시간 × 시급 × 1.5 (야간 50% 가산)
- **8시간 초과**:
  - 8시간 이내 야간: 시급 × 1.5 (야간 50%)
  - 8시간 초과 야간: 시급 × 2.0 (연장 50% + 야간 50%)

##### 휴일 야간 근무
- **8시간 이하**: 야간 시간 × 시급 × 2.0 (휴일 50% + 야간 50%)
- **8시간 초과**:
  - 8시간 이내 야간: 시급 × 2.0 (휴일 50% + 야간 50%)
  - 8시간 초과 야간: 시급 × 2.5 (휴일 50% + 연장 50% + 야간 50%)

#### 3. 공휴일 수당 (Holiday Pay)

**5인 이상 사업장만 적용**

##### 휴일 판정 기준
- **주말**: 토요일, 일요일
- **법정공휴일**: HolidayService에서 관리하는 공휴일 목록

##### 계산 공식
- **8시간 이하**: 휴일 근무 시간 × 시급 × 1.5 (휴일 50% 가산)
- **8시간 초과**:
  - 처음 8시간 (주간): 시급 × 1.5 (휴일 50%)
  - 초과 시간 (주간): 시급 × 2.0 (휴일 50% + 연장 50%)
  - 처음 8시간 (야간): 시급 × 2.0 (휴일 50% + 야간 50%)
  - 초과 시간 (야간): 시급 × 2.5 (휴일 50% + 연장 50% + 야간 50%)

#### 4. 주휴수당 (Weekly Paid Leave)

##### 지급 조건
- **주 15시간 이상** 근무 시 지급
- DELETED 상태의 근무 기록은 집계에서 제외

#### 계산 공식
```
주휴수당 = (주 소정근로시간 ÷ 40) × 8 × 시급
```

#### 예시
- 주 20시간 근무, 시급 10,000원인 경우:
  ```
  주휴수당 = (20 ÷ 40) × 8 × 10,000 = 40,000원
  ```

#### 5. 연장수당 (Overtime Pay)

**5인 이상 사업장만 적용**

연장수당은 두 가지 종류가 있습니다:

##### 5-1. 일 단위 연장수당 (Daily Overtime)

###### 지급 조건
- **일 8시간 초과** 근무 시 지급
- WorkRecord 레벨에서 자동 계산됨 (base_salary, night_salary, holiday_salary에 포함)

###### 계산 공식 (평일)
```
8시간 초과 시간 × 시급 × 1.5 (50% 할증)
```

###### 예시 (평일)
- 일 10시간 근무 (모두 주간), 시급 10,000원:
  ```
  처음 8시간: 8 × 10,000 = 80,000원
  초과 2시간: 2 × 10,000 × 1.5 = 30,000원
  총: 110,000원
  ```

###### 계산 공식 (휴일)
```
처음 8시간: 시급 × 1.5 (휴일 50%)
8시간 초과: 시급 × 2.0 (휴일 50% + 연장 50%)
```

###### 예시 (휴일)
- 휴일 10시간 근무 (모두 주간), 시급 10,000원:
  ```
  처음 8시간: 8 × 10,000 × 1.5 = 120,000원
  초과 2시간: 2 × 10,000 × 2.0 = 40,000원
  총: 160,000원
  ```

##### 5-2. 주 단위 연장수당 (Weekly Overtime)

###### 지급 조건
- **주 40시간 초과** 근무 시 지급
- DELETED 상태의 근무 기록은 집계에서 제외
- WeeklyAllowance에서 주 단위로 계산됨

###### 계산 공식
```
주 연장수당 = 초과 시간 × 시급 × 1.5 (50% 할증)
```

###### 예시
- 주 45시간 근무, 시급 10,000원:
  ```
  초과 시간 = 45 - 40 = 5시간
  연장수당 = 5 × 10,000 × 1.5 = 75,000원
  ```

## 🔄 마지막 주차 수당 이월 정책

### ⚠️ 중요: 이월 원칙

**마지막 주차**(월급날이 포함된 주)의 **주휴수당과 연장수당**은 **다음 달 급여로 이월**됩니다.

### 이월 이유
- 주휴수당/연장수당은 **주 단위로 계산**됨
- 월급날이 주 중간에 있으면, 해당 주가 완전히 끝나지 않은 상태
- 주가 완전히 끝난 후(다음 주 월요일 시작) 정확한 계산 가능

### 마지막 주차 판단 기준
- 월급날이 해당 주(월요일 ~ 일요일)에 포함되는지 확인하여 마지막 주차 여부를 판단합니다.

### 구체적인 예시

#### 예시 1: 월급날이 수요일인 경우
```
월급날: 2024년 1월 15일 (수요일)

[1월 8일(월) ~ 1월 14일(일)] 주:
  - 주휴수당: 1월 급여에 포함 ✅
  - 연장수당: 1월 급여에 포함 ✅

[1월 15일(월) ~ 1월 21일(일)] 주:  ⚠️ 마지막 주차
  - 월급날(1월 15일)이 이 주에 포함됨
  - 주휴수당: 2월 급여로 이월 ⏭️
  - 연장수당: 2월 급여로 이월 ⏭️

[1월 22일(월) ~ 1월 28일(일)] 주:
  - 주휴수당: 2월 급여에 포함 ✅
  - 연장수당: 2월 급여에 포함 ✅
```

#### 예시 2: 월급날이 월요일인 경우
```
월급날: 2024년 2월 5일 (월요일)

[2월 5일(월) ~ 2월 11일(일)] 주:  ⚠️ 마지막 주차
  - 월급날(2월 5일)이 이 주의 첫날
  - 주휴수당: 3월 급여로 이월 ⏭️
  - 연장수당: 3월 급여로 이월 ⏭️
```

### 이월 처리 로직

1. **당월 주간 수당 처리**
   - 마지막 주차를 제외한 모든 주차의 주휴수당과 연장수당을 현재 월 급여에 포함

2. **전월에서 이월된 수당 포함**
   - 전월의 마지막 주차였던 주간 수당(주휴수당, 연장수당)을 현재 월 급여에 추가

## 🧮 총 급여 계산

### 1. 총 지급액 (Gross Pay)
```
총 지급액 = 기본급 + 야간수당 + 공휴일수당 + 주휴수당 + 연장수당
```

### 2. 공제액 (Deductions)

공제는 계약의 `payrollDeductionType`에 따라 다르게 적용됩니다:

#### 공제 유형 (PayrollDeductionType)
1. **FREELANCER**: 소득세 3.3% (소득세 3% + 지방소득세 0.3%)
2. **PART_TIME_NONE**: 공제 없음
3. **PART_TIME_TAX_ONLY**: 소득세만 공제
4. **PART_TIME_TAX_AND_INSURANCE**: 소득세 + 4대보험 공제

#### 4대 보험 요율
- **국민연금**: 4.5% (최소 기준월급 39만원)
- **건강보험**: 3.545%
- **장기요양보험**: 건강보험의 12.95%
- **고용보험**: 0.9%

#### 소득세 간이 계산 (TODO: 실제 간이세액표 적용 필요)
- 100만원 미만: 3%
- 100~200만원: 3.5%
- 200만원 이상: 4%
- **지방소득세**: 소득세의 10%

#### 특별 규칙
- **급여가 0원인 경우**: 4대보험 자동 면제

### 3. 실수령액 (Net Pay)
```
실수령액 = MAX(0, 총 지급액 - 총 공제액)
```
- 공제액이 총 지급액을 초과하는 경우 실수령액은 0원으로 설정 (음수 방지)

## 📊 급여 계산 시점

### 자동 재계산 트리거

1. **근무 완료 처리 시** (SCHEDULED → COMPLETED)
   - 예정된 근무를 완료 처리하면 급여가 자동으로 재계산됩니다.

2. **COMPLETED 상태의 근무 기록 수정 시**
   - 이미 완료된 근무 기록을 수정하면 급여가 자동으로 재계산됩니다.

3. **과거 날짜로 근무 기록 생성 시**
   - 과거 날짜로 근무 기록을 생성하면 자동으로 COMPLETED 상태가 되며 급여가 재계산됩니다.

### 재계산되지 않는 경우

1. **SCHEDULED 상태 근무 기록 생성/수정 시**
   - 예정된 근무는 급여에 영향 없음

2. **SCHEDULED 상태 근무 기록 삭제 시**
   - 예정된 근무 삭제는 급여에 영향 없음

## 🔍 주의사항

### 1. WeeklyAllowance 생성 시점
- 근무 기록이 생성될 때 자동으로 해당 주차의 WeeklyAllowance도 생성됩니다.
- 주차는 **월요일~일요일** 기준으로 계산됩니다.

### 2. 급여 계산 정확도
- 모든 금액은 `BigDecimal`을 사용하여 정확한 계산을 보장합니다.
- 반올림은 `RoundingMode.HALF_UP` 방식을 사용합니다.

### 3. 월급날 설정
- 계약(Contract) 생성 시 `paymentDay` 필드에 설정됩니다.
- 1~28일 사이의 값을 권장합니다 (월급날이 말일을 초과할 경우 해당 월의 마지막 날로 자동 보정됩니다).

### 4. 데이터 정합성
- WorkRecord는 반드시 WeeklyAllowance와 연결되어야 합니다.
- WeeklyAllowance는 반드시 Contract와 연결되어야 합니다.
- Salary는 반드시 Contract와 연결되어야 합니다.

## 🔗 관련 파일

### 엔티티
- `WorkRecord.java` - 근무 기록
- `WeeklyAllowance.java` - 주간 수당
- `Salary.java` - 월급
- `WorkerContract.java` - 근로 계약

### 서비스
- `WorkRecordCalculationService.java` - 근무 기록 급여 계산 (사업장 규모 및 휴일 고려)
- `WorkRecordCommandService.java` - 근무 기록 생성/수정/삭제
- `WorkRecordCoordinatorService.java` - 근무 기록과 다른 도메인 간 협력
- `WeeklyAllowanceService.java` - 주간 수당 계산
- `SalaryService.java` - 급여 계산
- `HolidayService.java` - 휴일 판정

### 컨트롤러
- `EmployerWorkRecordController.java` - 고용주용 근무 기록 API
- `WorkerWorkRecordController.java` - 근로자용 근무 기록 API

## 📚 참고 자료

- 근로기준법 제56조 (연장·야간 및 휴일 근로)
- 근로기준법 시행령 제6조 (주휴일)
- 최저임금법

---

**작성일**: 2024년
**최종 수정일**: 2024년
**버전**: 1.0.0
